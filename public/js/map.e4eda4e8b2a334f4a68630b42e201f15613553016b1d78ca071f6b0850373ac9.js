(()=>{(function(){"use strict";let B=typeof window.FOLKLORE_MAP_BASE<"u"?window.FOLKLORE_MAP_BASE:"",S=typeof window.FOLKLORE_MAP_INDEX_URL<"u"?window.FOLKLORE_MAP_INDEX_URL:B+"map/index.json",d=[],a=null,P=null,u=null,m=Object.create(null),E=window.matchMedia("(prefers-reduced-motion: reduce)").matches;function c(){let t=new URLSearchParams(window.location.search);return{q:(t.get("q")||"").trim(),tags:t.get("tags")?t.get("tags").split(",").map(function(e){return e.trim()}).filter(Boolean):[]}}function f(t){let e=new URLSearchParams;t.q&&e.set("q",t.q),t.tags.length&&e.set("tags",t.tags.join(","));let n=e.toString(),o=window.location.pathname+(n?"?"+n:"");window.history.replaceState({},"",o)}function A(t,e,n){let o=e.toLowerCase(),r=[t.title,t.place,t.county,t.region].concat(t.tags||[]),i=!e||r.some(function(h){return String(h).toLowerCase().includes(o)}),s=n.size===0||(t.tags||[]).some(function(h){return n.has(String(h).toLowerCase())});return i&&s}function I(){let t=c(),e=new Set(t.tags.map(function(n){return n.toLowerCase()}));return d.filter(function(n){return A(n,t.q,e)})}function F(t){if(!t)return"";let e=t.replace(/\/$/,"").split("/");return e[e.length-1]||""}function x(t){let e=g(t.title),n=g([t.place,t.county].filter(Boolean).join(", ")),o='<a href="'+b(t.url)+'">Read more</a>';return'<div class="map-popup"><strong>'+e+"</strong><br>"+n+"<br>"+o+"</div>"}function M(t){u&&(a.removeLayer(u),m=Object.create(null)),u=typeof L.markerClusterGroup=="function"?L.markerClusterGroup({animate:!E}):L.layerGroup(),t.forEach(function(e){let n=Number(e.lat),o=Number(e.lng);if(Number.isNaN(n)||Number.isNaN(o))return;let r=L.marker([n,o]);r.entry=e,r.bindPopup(x(e),{className:"folklore-popup"}),r.on("popupopen",function(){y(e.url)}),u.addLayer(r),m[e.url]=r}),a.addLayer(u)}function y(t){document.querySelectorAll("#results-list [data-entry-url]").forEach(function(e){e.classList.toggle("active",e.getAttribute("data-entry-url")===t)})}function w(t){let e=m[t];if(!e||!a)return;let n=e.getLatLng();E?a.setView(n,a.getZoom()):a.flyTo(n,Math.max(a.getZoom(),12)),e.openPopup(),y(t)}function g(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}function b(t){return String(t).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function q(){let t=new Set;return d.forEach(function(e){(e.tags||[]).forEach(function(n){t.add(n)})}),Array.from(t).sort()}function p(t){let e=document.getElementById("tag-chips");if(!e)return;let n=q();e.innerHTML="",n.forEach(function(o){let r=document.createElement("button");r.type="button",r.className="tag-chip"+(t.indexOf(o)>=0?" tag-chip-active":""),r.setAttribute("role","checkbox"),r.setAttribute("aria-checked",t.indexOf(o)>=0?"true":"false"),r.textContent=o,r.dataset.tag=o,r.addEventListener("click",function(){k(o)}),r.addEventListener("keydown",function(i){(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),k(o))}),e.appendChild(r)})}function k(t){let e=c(),n=e.tags.map(function(o){return o.toLowerCase()}).indexOf(t.toLowerCase());n>=0?e.tags.splice(n,1):e.tags.push(t),e.tags.sort(),f(e),p(e.tags),l()}function l(){let t=I();M(t),v(t),O()}function O(){let t=c(),e=document.getElementById("clear-filters");e&&(e.disabled=!t.q&&t.tags.length===0)}function v(t){let e=document.getElementById("results-list"),n=document.getElementById("results-empty");!e||(e.innerHTML="",n&&(n.hidden=!0),t.forEach(function(o){let r=document.createElement("li");r.className="result-item",r.setAttribute("data-entry-url",o.url);let i=[o.place,o.county].filter(Boolean).join(", ");r.setAttribute("role","button"),r.tabIndex=0,r.innerHTML='<span class="result-title">'+g(o.title)+"</span>"+(i?'<span class="result-meta">'+i+"</span>":"")+' <a href="'+b(o.url)+'" class="result-read-more">Read more</a>',r.addEventListener("click",function(s){s.target.classList.contains("result-read-more")||(s.preventDefault(),w(o.url))}),r.addEventListener("keydown",function(s){s.target.classList.contains("result-read-more")||(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),w(o.url))}),e.appendChild(r)}),n&&t.length===0&&(n.hidden=!1))}function N(){let t=document.getElementById("search-input");if(!t)return;let e=null;t.addEventListener("input",function(){clearTimeout(e),e=setTimeout(function(){let n=c();n.q=t.value.trim(),f(n),l()},150)}),t.addEventListener("keydown",function(n){if(n.key==="Escape"){t.value="";let o=c();o.q="",f(o),p(o.tags),l()}})}function T(){let t=document.getElementById("clear-filters");!t||t.addEventListener("click",function(){f({q:"",tags:[]});let n=document.getElementById("search-input");n&&(n.value=""),p([]),l()})}function R(){let t=document.getElementById("panel-toggle"),e=document.getElementById("results-panel-content");!t||!e||t.addEventListener("click",function(){let n=e.classList.toggle("is-open");t.setAttribute("aria-expanded",n?"true":"false"),t.querySelector(".toggle-label").textContent=n?"Hide filters & results":"Show filters & results"})}function _(){let t=document.getElementById("map");!t||(a=L.map(t,{center:[53.3,-7.7],zoom:7,zoomControl:!0}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:19}).addTo(a),L.control.zoom({position:"topright"}).addTo(a))}function C(){_(),N(),T(),R(),fetch(S,{cache:"default"}).then(function(t){return t.json()}).then(function(t){d=Array.isArray(t)?t:[];let e=c(),n=document.getElementById("search-input");n&&(n.value=e.q),p(e.tags),l()}).catch(function(){d=[],v([]),document.getElementById("results-empty").hidden=!1,document.getElementById("results-empty").textContent="Could not load entries."})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",C):C()})();})();
